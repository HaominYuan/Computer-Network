# 服务器概览

- 服务器程序的结构

  - 将程序分为两个模块，即等待连接模块和负责与客户端通信的模块。
  - 当服务器程序启动并读取配置文件完成初始化后，就会运行等待连接模块。
  - 运行等待模块会创建套接字（可以事先启动多个），然后进入等待连接的暂停状态。
  - 当客户端发起连接时，等待模块会恢复运行并接收连接，然后启动客户端通信模块，并移交完成连接的套接字。
  - 客户端通信模块就会使用已连接的套接字越客户端进行通信，通信结束后，这个模块就退出。

- 服务端的套接字和端口号

  - 客户端的数据收发需要经过下面 4 个阶段：

    1. 创建套接字（创建套接字阶段）
    2. 用管道连接服务器端的套接字（连接阶段）
    3. 收发数据（收发阶段）
    4. 断开管道并删除套接字（断开阶段）

  - 服务器的收发数据需要经过下面 5 个阶段：

    1. 创建套接字（创建套接字阶段）
    2. 将套接字设置为等待连接状态（等待连接阶段）
    3. 接受连接（接受连接阶段）
    4. 收发数据（收发阶段）
    5. 断开管道并删除套接字（断开阶段）

  - 服务器程序的通信操作

    ```
    # 等待连接模块
    开始操作;
    ...
    <描述符 1> = socket(<使用IPv4>, <使用 TCP>, ...);
    ...
    bind(<描述符 1>, <端口号等>, ...);
    ...
    listen(<描述符 1>, ...);
    ...
    <描述符 2> = accept(<描述符 1>, ...);
    ...
    嗲用客户端通信模块(<描述符 2>);
    ...
    返回accept;
    ...
    ```

    ```c
    # 客户端通信模块
    <接受数据长度> = read(<描述符 2>, <接受缓冲区>, <接收缓冲区长度>);
    ...
    <根据请求消息的内容进行处理>;
    ...
    ...
    write(<描述符 2>, <发送数据>, <发送数据长度>);
    ...
    close(<描述符 2>);
    ...
    结束;
    ```

  - 服务端套接字的确认需要下面 4 种信息来判断

    - 客户端 IP 地址
    - 客户端端口号
    - 服务器 IP 地址
    - 服务器端口号

  - 用描述符来指代套接字的原因如下

    - 等待连接的套接字中没有客户端 IP 地址和端口号。
    - 使用描述符这一种信息比较简单。



# 服务器的接收操作

- 网卡将接收到的信号转换成数字信号
  - 网卡接收到信号，然后将其还原成数字信息。
  - 根据校验公式计算接收到的数字信息，然后与包末尾的 FCS 值进行比较。如果错误则丢弃。
  - 检查 MAC 头部中的接收方 MAC 地址是不是与网卡 ROM 中的 MAC 地址是否相同。如果不是则丢弃。
  - 将数字信息保存在网卡的内部缓冲区中。
  - 网卡通过中断将网络包到达的事件通知给 CPU。
  - CPU 暂停工作，并切换到网卡的任务。根据 MAC 头部的以太网类型字段判断协议的协议的种类，并调用负责处理该协议的软件。
- IP 模块的接收操作
  - IP 模块检查 IP 头部的格式是否符合规格，然后检查接收方 IP 地址是不是与网卡地址相同。当服务器启用类似路由器的包转发功能时，对于不是发给自己的包，会像路由器一样根据路由表进行转发。
  - 检查是否分片。如果分片则等所有分片全部到达后将分片组装还原成原始包。
  - 检查 IP 头部的协议号字段，并将包交给相应的模块。
- TCP 模块处理连接包
  - 当 TCP 头部中的控制为 SYN 为 1 时，表示这是一个发起连接的包。TCP 模块会先检查包的接收方端口号，并确认在该端口号上有没有与接收方端口号相同并且正在处于等待连接状态的套接字。如果指定端口号没有等待连接的套接字，则向客户端返回错误通知的包。
  - 如果存在等待连接的套接字，则为这个套接字复制一个新的副本，并将发送方 IP 地址、端口号、序列值、窗口大小等必要的参数写入这个套接字中，同时分配用于发送缓冲区和接收区的内存空间。然后生成代表确认的 ACK 号、用于从服务器向客户端发送数据的序号初始值，表示接收缓冲区剩余容量的窗口大小，生成 TCP 头部，委托 IP 模块发送给客户端。
  - 客户端返回表示接收确认的 ACK 号，当这个 ACK 号返回服务器后，连接操作完成。
  - 服务端的程序进入调用 accept 的暂停状态。
- TCP 模块处理数据包
  - TCP 模块根据 TCP 头部中的发送发 IP 地址 和接收方 IP 地址，以及接收方端口号和发送方端口号共 4 种信息，找到上述 4 种信息全部匹配的套接字。
  - TCP 模块会对比该套接中保存的数据收发状态和收到的包的头部 TCP 头部中的信息是否匹配，以确定数据收发操作是否正常。随后将数据放入缓冲区并将数据进行拼接。
  - 数据进入缓冲区后， TCP 模块生成确认应答的 TCP头部，并根据接收包的序号和数据长度计算出 ACK 号，然后委托 IP 模块发送给客户端。
  - 应用程序调用 Socket 库的 read 来获取睡觉。
- TCP 模块的断开操作（假设服务器先断开）
  - 服务器程序调用 Socket 库的 close，TCP 模块生成一个控制 FIN 为 1 的 TCP 头部，并委托 IP 模块发送给客户端。
  - 客户端收到包后返回一个 ACK 号。
  - 客户端与服务器相同。
  - 最后，套接字会在经过一段时间后删除。



# Web 服务器程序解释请求消息并作出响应

- 将请求的 URI 转换为实际的文件名

  - Web 服务器公开的目录不是磁盘上的实际目录，读取文件时，需要先查询虚拟目录与实际目录的对应关系，并将 URI 转换成实际的文件名后，才能读取文件并返回数据。
  - 当 URI 中的路径省略了文件名时，服务器会读取事先设置好的默认文件名。

- Web 服务器的访问控制

  Web 服务器的访问控制规则主要有以下 3 种：

  - 客户端 IP 地址
  - 客户端域名
  - 用户名和密码



# 浏览器接收响应并显示内容

- 通过响应的数据类型判断其中的内容

  - 浏览器根据响应消息开头的 Content-Type 头部字段的值来判断数据类型。

  - 消息的 Content-Type 定义的数据类型

    | 主类型      | 含义                                                         | 子类型示例                              | 解释                                                         |
    | ----------- | ------------------------------------------------------------ | --------------------------------------- | ------------------------------------------------------------ |
    | text        | 表示文本数据                                                 | text/html<br />text/plain               | HTML 文档<br />纯文本                                        |
    | image       | 表示图像数据                                                 | image/jpeg<br />image/gif               | JPEG 格式的图片<br />GIF格式的图片                           |
    | audio       | 表示音频数据                                                 | audio/mpeg                              | MP2、MP3 格式的音频                                          |
    | video       | 表示视频数据                                                 | video/mpeg<br />video/quicktime         | MPEG 格式的视频<br />Quicktime 格式的视频                    |
    | model       | 表示对物体等的形状和动作进行建模的数据                       | model/vrml                              | VRML 格式的建模数据                                          |
    | application | 除上述以外的数据，Excel、Word 等应用程序的数据都属于这一类型 | application/pdf<br />application/msword | PDF 格式的文档数据<br />MS-WORD 格式的文档数据               |
    | message     | 直接存放邮件等消息时使用的类型，表示直接存放某种格式的消息   | message/rfc822                          | 一般的邮件数据：包含From：、Date：等头部数据                 |
    | multipart   | 消息体中包含多个部分的数据                                   | multipart/mixed                         | 消息体中包含各种不同格式的数据，其中每个部分的数据都有单独定义的媒体类型 |

  - 当数据类型为文本时，还需要判断编码方式，这时需要用 charset 附加表示文本编码方式的信息。

  - 检查 Content-Encoding 头部字段，判断消息中存放的内容是通过压缩或编码技术对原始数据进行转换得到的。