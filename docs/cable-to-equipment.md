# 信号在网线和集线器中传输

- 每个包都是独立传输的

  所有的包在传输到目的地的过程中都是独立的，相互之间没有任何关联。

- 防止网线中的信号衰减很重要

  - 网线越长，信号衰减越严重。
  - 电信号的频率越高，能量的损失率越大，使得定好波形发生变化。
  - 衰减的信号和失真是产生通信错误的原因。

- “双绞” 是为了抑制噪声

  双绞线可以抑制电磁波产生的电流。

- 集线器将信号发往所有路线

  - 信号进入集线器的 PHY（MAU）模块后，会进入中继电路。中继电路的基本功能就是将输入的信号广播到集线器的所有的端口上。
  - 交换机只是原封不动地将信号广播出去，所以即便信号受到噪声的干扰发生了失真，也会原样发送到目的地。



# 交换机的包转发操作

- 交换机根据地址表进行转发
  - 当信号从双绞线传入，进入 PHY（MAU）模块的接收部分，PHY（MAU）模块会将网线中的信号转换为通用恶事，然后传递给 MAC 模块。
  - MAC 模块将信号转换为数字信号，然后通过包末尾的 FCS 校验错误，如果没有问题则存放到缓冲区中；如果监测到错误就丢弃这个包。
  - 查询接收方 MAC 地址是否已经在 MAC 地址表中有记录。
    - 如果有记录则通过交换电路将包发送到相应的端口。
    - 如果没有记录则将包转发到除了源端口之外的所有端口上。
- MAC 地址表的维护
  - 收到包时，将发送方 MAC 地址以及其输入端口的号码写入 MAC 地址表中。
  - 地址表中的记录在一段时间不使用后就自动删除。



# 路由器的包转发操作

- 路由器的基本知识

  路由器的每个端口都具有 MAC 地址和 IP 地址

- 路由表中的信息

  - 路由器根据 “IP 地址” 判断转发目标。
  - 对路由表进行维护的方法有两种：
    - 由人手动维护路由记录
    - 根据路由协议机制（如 RIP、OSPC、BGP等），通过路由器之间的信息交换路由器自行维护路由表的记录。

- 路由器的包接收操作

  路由器的端口具有 MAC 地址，直接收于自身地址匹配的包，遇到不匹配的包则直接丢弃。

- 查询路由表确定输出端口

  - 将包中的接收方 IP 地址与子网掩码进行匹配，找到与接收方 IP 地址匹配的目标地址。
  - 目标地址可能有多条，按照目标地址最长中跃点计数最小的选择目标地址。
  - 如果找不到匹配的记录，路由器会丢弃这个包，并通过 ICMP 消息通知发送方。

- 找不到匹配路由时选择默认路由

  路由表中子网掩码为 0.0.0.0 的记录表示 “默认路由”。

- 包的有效期

  网络包在被转交给输出端口之前，路由器更新 IP 头部中的 TTL（Time to Live，生存时间）字段，实际上是减 1。当这个值变为 0 时，这个包将会被丢弃。

- 通过分片功能拆分大网络包

  - 当输出端口的 MTU 大于等于转发的包长，那么就可以不分片直接发送；如果输出端口的 MTU 小于转发的包长，那么需要将包按照这个 MTU 进行分片。
  - 查询 IP 头部的字段 Flag 判断是否能分片，如果不能分片只能丢弃这个包，并通过 ICMP 消息通知发送方。一般来说都是可以分片的，但下面两种情况不能分片：
    - 发送方应用程序等设置了不允许分片。
    - 这个包已经是经过分片后的包。

- 路由器的发送操作和计算机相同

  - 路由器判断下一个转发目标的方法如下
    - 如果路由表的网管列内容为 IP 地址，则该地址就是下一个转发目标。
    - 如果路由表的网关列内容为空，则 IP 头部中的接收方 IP 地址就是下一个转发目标。
  - 路由器会使用 ARP 来查询下一个转发目标的 MAC 地址。

- 路由器与交换机的关系

  - IP（路由器）负责将包发送给通信对象这一整体过程，而其中将包传输到下一个路由器的过程则是由以太网（交换机）来负责的。



# 路由器的附加功能

- 通过地址转换有效利用 IP 地址

  - 问题背景：随着进入互联网的设备数量快速增长，可分配的地址快速减少。
  - 内网互相独立，两个内网具有相同的 IP 并不影响两个内网内部的数据传输。
  - 在内网中可用私有地址的范围为：
    - 10.0.0.0 ～ 10.255.255.255
    - 172.16.0.0 ～ 172.31.255.255
    - 192.168.0.0 ～ 192.168.255.255
  - 内网中的设备和互联网进行连接的时候需要经过地址转换。

- 地址转换的基本原理

  - 地址转换的基本原理是在转发网络包时对 IP 头部中的 IP 地址和端口号进行改写。

  - TCP 连接操作的第一个包被转发到互联网时，地址转换设备会将发送方 IP 地址从私有地址改写成公有地址。端口号改写成一个空闲的端口号。然后改写前的私有地址和端口号，以及改写后的公有地址和端口号，会作为一组相对应的记录保存在地址转换设备内部的一张表中。

  - 地址和端口对应表

    | 公有地址    | 端口号 | 私有地址  | 端口号 |
    | ----------- | ------ | --------- | ------ |
    | 198.18.8.31 | 5436   | 10.10.1.1 | 1025   |
    | 198.18.8.31 | 5437   | 10.10.1.2 | 1025   |
    | 198.18.8.31 | 5438   | 10.10.1.3 | 2538   |

- 从互联网访问公司内网

  - 用于外网访问的服务器可以放在地址转换设备的外面并为它分配一个公有地址。
  - 可以讲服务器的私有地址手动添加到地址转换设备中。

- 路由器的包过滤功能

  包过滤就是在对包进行转发时，根据 MAC 头部、IP 头部、TCP 头部的内容，按照事先设置好的规则决定是转发这个包，还是丢弃这个包。