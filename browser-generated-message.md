# 生成HTTP请求信息

- 网址准确来说应该称之为 URL 。

- 浏览器是一个具备多种客户端功能的综合性客户端软件，因此需要不同的 URL 来判断应该使用其中哪种功能来访问响应的数据。

  - 用 Http 协议访问 Web 服务器时

    ```markdown
    http://user:password@www.glasscom.com:80/dir/file1.htm
    ```

    用户名（user） 可省略；密码（password） 可省略；端口号（80）可省略。

  - 用 FTP 协议下载和上传文件时

    ```markdown
    ftp://user:password@ftp.glasscom.com:21/dir/file1.html
    ```

    用户名（user）可省略；密码（password）可省略；端口号（21）可省略。

  - 读取客户端计算机本地文件时

    ```markdown
    file://localhost/c:/path/file1.zip
    ```

    计算机名（localhost）可省略。

  - 发送电子邮件时

    ```markdown
    mailto:tone@glasscom.com
    ```

  - 阅读新闻组的文章时

    ```markdown
    new:comp.protocols.tcp-ip
    ```

- 浏览器先要解析 URL（**第一步**）

  URL 的元素：`http:` + `//` + `Web 服务器名` + `/` + `目录名` + `/` + … + `文件名`

  从第一个斜杠起（包括第一斜杠），后面的所有元素都表示数据源（文件）的路径名。

- 省略文件名的情况

  - 当 URL 是以 ”/“ 来结尾时

    ```
    http://www.lab.glasscom.com/dir/
    ```

    一般会在服务器上实现设置好文件名省略时要访问的默认文件名。这个设置根据服务器不同而不同，大多是情况下是 index.html 或者 default.htm 之类的文件名。

  - 当省略路径名时

    ```
    http://www.lab.glasscom.com
    ```

    代表访问根目录下实现设置的默认文件。最早的时候这个文件被叫做“主页”（home page）。

  - 无法分清楚是文件还是文件名时

    ```markdown
    http://www.lab.glasscom.com/whatisthis
    ```

    如果 Web 服务器上存在名为 whatisthis 的文件，则将 whatisthis 作为文件名来处理；如果存在名为 whatisthis 的目录，则将 whatisthis 作为路径名来处理。

- HTTP 的基本思路

  - 首先客户端会向服务器发送请求信息。请求信息中包含的内容是“对什么”和“进行怎样的操作“两个部分

    - ”对什么“的部分称为 URI。例如：“/dir/file1.html”、“/dir1/program1.cgi”等。也可以直接使用 URL 作为 URI（在代理中应用）。

    - “进行怎样的操作”的部分称为方法。

      |  方法   | 含义                                                         |
      | :-----: | :----------------------------------------------------------- |
      |   GET   | 获取URI指定的信息。如果 URI 指定的是文件，则返回文件的内容；如果URI 指定的是 CGI 程序，则返回该程序的输出数据。 |
      |  POST   | 从客户端向服务器发送数据。一般用于发送表单中填写的数据等情况下。 |
      |  HEAD   | 和 GET 基本相同。不过它值返回 HTTP 的消息头（message header），而并不返回数据的内容。用于获取文件最后更新时间等信息。 |
      | OPTIONS | 用于同志或擦讯通信选项。                                     |
      |   PUT   | 替换 URI 指定的服务器上的文件。如果 URI 指定的文件不存在，则创建该文件。 |
      | DELETE  | 删除 URI 指定的服务器上的文件。                              |
      |  TRACE  | 将服务器收到的请求行和头部（header）直接返回给客户端。用于在使用代理的环境中检查改写请求的情况。 |
      | CONNECT | 使用代理传输加密消息时使用的方法。                           |

    - GET、POST、PUT 、DELETE 方法区别

      **From https://www.zhihu.com/question/27622127/answer/37676304**

      **From https://www.oschina.net/translate/what-does-restful-really-mean?cmp**

      我们可以根据三种属性来区分这四种方法。三种属性分别为：安全性、幂等性、是否有消息体 。

      幂等性：一个请求原封不动的发送N次和M次（N不等于M，N和M都大于1）服务器上资源的状态最终是一致的。

      安全性：对客户端来说操作不会产生副作用。当发送完一个请求以后，网站上的资源状态没有发生修改，即认为这个请求是无副作用的。

      | 方法   | 安全性 | 幂等 | 消息体 |
      | ------ | ------ | ---- | ------ |
      | GET    | 是     | 是   | 否     |
      | POST   | 否     | 否   | 是     |
      | PUT    | 否     | 是   | 是     |
      | DELETE | 否     | 否   | 否     |

  - HTTP 消息中还有一些用来附加信息的头字段。客户端向Web服务器发送数据时，会先发送头字段，然后再发送数据。

  - Web服务器会对请求消息进行解析，通过URI和方法来判断“对什么”和“进行怎样的操作”，并根据这些要求来完成自己的工作，然后将结果存放在响应消息中。

- 生成 HTTP 请求消息（**第二步**）

  - 第一行为请求行。请求行包括请求方法、路径名、版本号三个字段。

    请求方法是根据场景来确定的。在地址栏输入网页并显示网页和电机超链接的场景用的是 GET 方法。如果是表单，可能是 GET 方法 或者是 POST 方法。

    ```html
    <form method="GET" action="/cgi/sample.cgi">
        <input type="text" name="Field1" size="20">
        <input type="submit" value="SEND" name="SendButton">
        <input type="reset" value="RESET" name="ResetButton">
    </form>
    ```

    当 method="GET" 时的消息

    ```markdown
    GET /cgi/sample.cgi?Field1=ABCDEFG&SendButton=SEND HTTP/1.1
    ```

    当 method="POST" 时的消息

    ```markdown
    POST /cgi/sample.cgi HTTP/1.1
    （若干行头字段）
    Field1=ABCDEFG&SendButton=SEND
    ```

    路径名在URL中，因此只要从URL中提取出来原封不动写上去就好。

  - 第二行开始为消息头

    消息头的功能是用来存放一些额外的详细信息。例如：日期、客户端支持的数据类型、语言、压缩格式、客户端和服务端的软件名称和版本、数据有效期和最后更新时间等。

  - 紧接着消息头的下一行为一个完全没有内容的空行。

  - 空行后卫消息体。浏览器可以根据请求的方法来判断是否需要添加消息体。例如：GET 和 DELETE 是不需要添加消息体；POST 和 PUT 方法是需要添加。

  - 请求消息格式

    ```html
    <方法><空格><URI><空格><HTTP版本>
    <字段名>:<字段值>
    …
    …
    …
    <空行>
    <消息体>
    ```

    啊师

- 发送请求后会收到响应

  - 响应消息的格式以及基本思路和请求消息时相同的，差别只在第一行。在响应消息中，第一行的内容为状态码和响应短语。

  - HTTP 状态码概要

    | 状态码 | 含义                     |
    | ------ | ------------------------ |
    | 1XX    | 告知请求的处理进度和情况 |
    | 2XX    | 成功                     |
    | 3XX    | 表示需要进一步操作       |
    | 4XX    | 客户端错误               |
    | 5XX    | 服务器错误               |

  - 响应消息格式

    ```markdown
    <HTTP版本><空格><状态码><空格><响应短语>
    <字段名>:<字段值>
    …
    …
    …
    <空行>
    <消息体>
    ```

  - 由于每条请求消息中只能有一个URI，所以每次只能获取一个文件。如果需要获取多个文件，必须对每个文件单独发送请求。例如：当网页中包含图片时，浏览器会单独发送一个请求来获取图片。



# 向 DNS 服务器查询 Web 服务的 IP 地址

- IP 地址的基本知识

  - 生成 HTTP 消息之后，浏览器会委托操作系统将消息发送给 Web 服务器。在委托操作系统发送消息时，必须要提供通信对象的 IP 地址。

  - IP地址的表示

    - IP 地址主体的表示方法

      ```markdown
      10.11.12.13
      ```

    - 采用与 IP 地址主体相同的格式表示子网掩码的方法

      ```markdown
      10.11.12.13/255.255.255.0
      ```

    - 采用网络号比特数来表示子网掩码的方法

      ```markdown
      10.11.12.13/24
      ```

    - 表示子网的地址

      ```markdown
      10.11.12.0/24
      ```

    - 表示子网内广播的地址

      ```markdown
      10.11.12.255/24
      ```

- 域名和 IP 地址并用的理由

  - 为什么需要域名？

    就像很难记住电话号码一样，要记住一串由数字组成的 IP 地址也非常困难。

  - 为什么需要 IP？

    使用 IP 地址只需要处理 4 字节的数字，而域名则需要处理几十个到 255 个字节的字符。因此使用 IP 地址效率更高。

  - 为了填补两者之间的障碍，需要有一个机制能够通过名称来查询 IP 地 址，或者通过 IP 地址来查询名称，这样就能够在人和机器双方都不做出牺牲的前提下完美地解决问题。这个机制就是 DNS。 

- Socket 库提供查询 IP 地址的功能

  在计算机中存在DNS客户端，即解析器。解析器为一段程序，它包含在操作系统的socket库中。

- 通过解析器向 DNS 服务器发出查询

  - 用C语言编写的网络应用程序的源代码示例

    ```c
    <应用程序名>（<参数>）
    {
        …
        …
        <内存地址> = gethostbyname("www.lab.glasscom.com");
        …
        …
        <发送HTTP消息>
        …
    }
    ```

  - 调用解析后，解析器会向 DNS 服务器发送查询消息，然后 DNS 服务器发送返回响应信息。响应信息中包含查询到的 IP 地址，解析器取出 IP 地址，并将其写入浏览器指定的内存地址中。

- 解析器的内部原理

  - 解析器会生成要发送给 DNS 服务器的查询消息（DNS 服务器 IP 是实现设置好的，不需要查询）；
  - 向 DNS 服务器发送查询消息；
    - 发送 UDP 消息（操作系统内部的协议栈或者协议驱动）；
  - 接收DNS服务器返回的响应消息；
    - 接受 UDP 消息（操作系统内部的协议栈或者协议驱动）；
  - 从响应消息中取出 IP 地址，存放到<内存地址>中；
  - 返回应用程序



# 全世界 DNS 服务器的大接力

- DNS 服务器的基本工作

  - 来自客户端的查询消息包含一下 3 种信息。

    - 域名：服务器、邮件服务器（邮件地址中@后面的部分）的名称。
    - Class：如今除了互联网没有其他网络，因此 Class 的值永远是代表互联网的 IN。
    - 记录类型：标明域名对应的 IP 地址。A 表示域名的 IP 地址；MX 表示域名对应的邮件服务器。

  - DNS 服务器上的记录表

    | 域名                 | Class | 记录类型 | 响应数据             |
    | -------------------- | ----- | -------- | -------------------- |
    | www.lab.glasscom.com | IN    | A        | 192.0.2.226          |
    | glasscom.com         | IN    | MX       | 10 mail.glasscom.com |
    | mail.glasscom.com    | IN    | A        | 192.0.2.227          |

- 域名的层次结构

  DNS 服务器中的所有信息是按照域名以层次的结构来保存的。DNS 中的域名信息使用句点来分隔的，这里的逗号代表不同层次的界限。在域名中，越靠右的位置表示其层级越高。每个域的信息是作为一个整体存放 DNS 服务器中，不能将一个域拆开来存放在多台服务其中。一台 DNS 服务器中可以存放多个域的信息。

- 寻找相应的 DNS 服务器并获取 IP 地址（**第三步**）

  - 首先，将负责管理下级域的 DNS 服务器的 IP 地址注册到它们上级 DNS 服务器中。URL中的地址一般不写根域，根域为`.`。根域保存着 com、jp 等的 DNS 服务器信息。由于上级 DNS 服务器保管着所有下级 DNS 服务器的信息，所以我们可以从根域开始一路向下顺藤摸瓜找到任意一个域的 DNS 服务器。
  - 其次，将根域的 DNS 服务器信息保存在所有互联网中所有的 DNS 服务器中。这样，任何 DNS 服务器就都可以找到并访问根域 DNS 服务器。

- 通过缓存加快 DNS 服务器的响应

  - DNS 服务器有一个缓存功能，可以记住之前查询过的域名。并且当查询的域名不存在时，“不存在”这一响应结果也会被缓存。

  - DNS 服务器中保存的信息都设置有一个有效期，当缓存的信息超过有效期后，数据就会从缓存删除。并且在对查询进行响应时，DNS 服务器也会告知客户端这一响应的结果是来自缓存还是来自负责管理该域名的 DNS 服务器。



# 委托协议栈发送消息

- 数据首发操作概览
  - 首先服务器一方先穿件套接字，然后等待客户端向套接字连接管道。
  - 客户端创建一个套接字（穿件套接字阶段）
  - 客户端将管道连接到服务端的套接字上（连接操）
  - 收发数据（通信阶段）
  - 断开管道并删除套接字（断开阶段）
- 创建套接字阶段
  - 通过调用 Socket 库中的 socket 程序组件就可以创建套接字（同时随机分配了一个端口号）。
  - 协议栈会返回一个描述符。同一台计算机上可能同时存在多个套接字，描述符用于识别不同的套接字。
- 连接阶段：把管道接上去
  - 通过调用 Socket 库中的名为 connect 的组件来连接。连接需要指定描述符、服务器 IP 地址和端口号 3 个参数。
    - 描述符：connect 会将应用程序指定的描述符告知协议栈，然后协议栈根据这个描述符找到对应的套接字。然后将描述符对应的套接字与服务器的套接字进行连接，并执行连接的操作。
    - 服务器 IP：即通过 DNS 服务器查询得到的服务器 IP 地址。
    - 端口号：和服务器配合来识别的对方套接字。Web 是 80 端口；电子邮件是 25 号端口。
- 通信阶段
  - 通过 Socket 库中的 write 程序组件委托协议栈来完成发送数据这个操作。调用 write 时需要指定描述符和发送的数据。
  - 通过 Socket 库中的 read 程序组件委托协议栈来完成接收数据这个操作。调用read 时需要指定用于存放接收到的响应消息的内存地址，这一内存地址称为缓冲区。
- 断开阶段
  - 通过调用 Socket 库中的 close 程序组件进入断开阶段。